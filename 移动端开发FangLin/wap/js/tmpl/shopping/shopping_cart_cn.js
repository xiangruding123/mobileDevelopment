!function(t){function e(){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_cart&op=list",data:{mid:FL.mid,type:"db",flag:"wap",gc_area:0,token:FL.token},dataType:"json",success:function(t){if(t&&"0"==t.error){var e=template.render("goods_cn",t);$("#cart_cn").empty(),$("#cart_cn").html(e),T(),console.log(t),0==t.result.store_cart_list.length&&$(".bottom-frame").hide(),0!=$(".store_goods").length&&$("#edit").show(),F(),t.result.mansong&&addcookie("manzeng",JSON.stringify(t.result.mansong)),t.result.manselect_info&&sessionStorage.setItem("manselect_info",JSON.stringify(t.result.manselect_info)),$(".sub").click(_),$(".add").click(h),$(".num").keyup(m),$("#shopping").on("click",".single",n),$(".all").click(a),$(".store").click(i),$(".close").click(function(){var t=this;C(function(){p(t)})}),S(),v(),$(".post").click(j),$(".send").click(G)}else t&&8==t.error&&FL.logLogin()},error:function(t){}})}function n(){var t=this;r(t,"single"),v()}function a(){var t=this;r(t,"all"),v()}function i(){var t=this;r(t,"store"),v()}function r(t,e){"all"===e?$(t).hasClass("icon-ok-sign")?s(t):o(t):"single"==e?$(t).hasClass("icon-ok-sign")?c(t):l(t):$(t).hasClass("icon-ok-sign")?g(t):d(t),y()}function o(t){$(".single").attr("class","icon-ok-sign single"),$(".store").attr("class","icon-ok-sign store"),$(".all").attr("class","icon-ok-sign all")}function s(t){$(".single").attr("class","icon-circle-blank single font-gray"),$(".store").attr("class","icon-circle-blank store font-gray"),$(".all").attr("class","icon-circle-blank all")}function l(t){$(t).attr("class","icon-ok-sign single");var e=$(".icon-circle-blank.single.font-gray").length;e>0?$(".all").attr("class","icon-circle-blank all"):$(".all").attr("class","icon-ok-sign all");var n=$(t).parents(".store_goods").find(".single").length,a=$(t).parents(".store_goods").find(".icon-ok-sign.single").length;n==a?$(t).parents(".store_goods").find(".store-title .store").attr("class","icon-ok-sign store"):$(t).parents(".store_goods").find(".store-title .store").attr("class","icon-circle-blank store font-gray")}function c(t){$(t).attr("class","icon-circle-blank single font-gray"),$(".all").attr("class","icon-circle-blank all"),$(t).parents(".store_goods").find(".store-title .store").attr("class","icon-circle-blank store font-gray")}function d(t){$(t).attr("class","icon-ok-sign store"),$(t).parents(".store_goods").find(".container .single").attr("class","icon-ok-sign single");var e=$(".icon-circle-blank.single.font-gray").length;e>0?$(".all").attr("class","icon-circle-blank all"):$(".all").attr("class","icon-ok-sign all")}function g(t){$(t).attr("class","icon-circle-blank store font-gray"),$(".all").attr("class","icon-circle-blank all"),$(t).parents(".store_goods").find(".container .single").attr("class","icon-circle-blank single font-gray")}function p(t){var e=t,n=$(e).parents(".container").attr("cart_id");$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_cart&op=del",data:{mid:FL.mid,token:FL.token,cart_id:n,gc_area:0,flag:"wap"},dataType:"json",success:function(t){if(t&&"0"==t.error){var n=$(e).parents(".store_goods");$(e).parents(".container").next(".empty").remove(),$(e).parents(".container").remove();var a=n.find(".container");0==a.length&&n.remove(),v(),L()}}})}function f(t,e){var n=$(t).parents(".container").find(".goods-price").attr("top_limit"),a=$(t).parents(".container").find(".goods-price").attr("goods_price"),i=$(t).parents(".container").find(".goods-price").attr("killing_price"),r=$(t).parents(".container").find(".goods-price").attr("killing_stock"),o=$(t).parents(".container").find(".goods-price").attr("goods_storage"),s=$(t).parent(),l=$(s).attr("cart_id"),c=parseInt($(t).siblings("input").val());if("add"===e){if(c=++c,c>r&&c>o)return layer.msg("库存不足"),!1;$(t).siblings("input").val(c)}else c<=1?c=1:--c,$(t).siblings("input").val(c);var d=$(t).parents(".container").attr("stock");if(r>d||d&&d<c&&(layer.msg("库存紧张,最多购买"+d+"件哦!"),$(t).siblings("input").val(d),c=d),0!=$(t).parents(".container").find(".goods-limit").length){var g=$(t).parents(".container").find(".goods-limit").attr("limit"),p=$(t).parents(".container").find(".goods-limit").attr("limitPrice"),f=$(t).parents(".container").find(".goods-limit").attr("price");c>=g?$(t).parents(".container").find(".goods-price").text("￥"+p):$(t).parents(".container").find(".goods-price").text("￥"+f)}n&&(c>n&&0!=n?($(t).parents(".container").find(".goods-price").text("￥"+a),$(t).parents(".container").find(".app-seckill").remove(),$(t).parents(".container").find(".sk-limit").remove()):($(t).parents(".container").find(".goods-price").text("￥"+i),0==$(t).parents(".container").find(".app-seckill").length&&$(t).parents(".container").find(".goods-price").after('<img src="../../images/wap/app_miaosha.png" class="app-seckill" /><span class="sk-limit">限购'+n+"件</span>"))),u(t,l,c),v()}function m(t){var e=t;($(e.target).val()<=1||isNaN($(e.target).val()))&&$(e.target).val(1);var n=$(e.target).parent(),a=$(n).attr("cart_id"),i=parseInt($(e.target).val()),r=$(e.target).parents(".container").attr("stock"),o=$(e.target).parents(".container").find(".goods-price").attr("top_limit"),s=$(e.target).parents(".container").find(".goods-price").attr("goods_price"),l=$(e.target).parents(".container").find(".goods-price").attr("killing_price"),c=$(e.target).parents(".container").find(".goods-price").attr("killing_stock"),d=$(e.target).parents(".container").find(".goods-price").attr("goods_storage");if(i>c&&i>d)return layer.msg("库存不足"),$(e.target).val(1),!1;if(c>r||r&&r<i&&(layer.msg("库存紧张,最多购买"+r+"件哦!"),$(e.target).val(r),i=r),0!=$(e.target).parents(".container").find(".goods-limit").length){var g=$(e.target).parents(".container").find(".goods-limit").attr("limit"),p=$(e.target).parents(".container").find(".goods-limit").attr("limitPrice"),f=$(e.target).parents(".container").find(".goods-limit").attr("price");i>=g?$(e.target).parents(".container").find(".goods-price").text("￥"+p):$(e.target).parents(".container").find(".goods-price").text("￥"+f)}o&&(i>o&&0!=o?($(e.target).parents(".container").find(".goods-price").text("￥"+s),$(e.target).parents(".container").find(".app-seckill").remove(),$(e.target).parents(".container").find(".sk-limit").remove()):0==$(e.target).parents(".container").find(".app-seckill").length&&($(e.target).parents(".container").find(".goods-price").text("￥"+l),$(e.target).parents(".container").find(".goods-price").after('<img src="../../images/wap/app_miaosha.png" class="app-seckill" /><span class="sk-limit">限购'+o+"件</span>"))),u(e,a,i),v()}function u(t,e,n){$.ajax({url:WapSiteUrl+"/api/index.php?act=buyer_cart&op=update",type:"get",data:{token:FL.token,cart_id:e,quantity:n,mid:FL.mid,flag:"wap",gc_area:0},dataType:"json",success:function(t){t&&"0"==t.error||layer.msg(t.msg)}})}function h(){var t=this;f(t,"add")}function _(){var t=this;f(t,"sub")}function v(){var t=$(".icon-ok-sign.single"),e=0;0==t.length&&$("#settle").attr("class","btn-unshopping");for(var n=parseFloat("0.00"),a=0;a<t.length;a++){var i=$(t[a]).parent(),r=i.find(".goods-price").text().slice(1),o=i.find(".num").val();if(0!=i.parents(".container").find(".some-div").length){var s=i.parent().find(".some-div").length*o;e+=s}else e+=parseInt(o);n+=parseFloat(r*o)}addcookie("cartGoodsNum",e),$(".marker").text("共 "+e+" 件");try{k(n)}catch(l){}}function k(t){for(var e=$(".store_goods"),n=0;n<e.length;n++){var a=parseFloat("0.00"),i=parseFloat("0.00"),r=0,o=$(e[n]).find(".icon-ok-sign"),s=o.parents(".container.valid"),l=JSON.parse(sessionStorage.getItem("manselect_info"));try{var c=l[$(e[n]).find(".manselect").attr("store_id")].manselect_rules}catch(d){var c=[]}for(var g=0,p=0,f=0;f<s.length;f++)1==$(s[f]).attr("goods_activity_state")&&(h=$(s[f]).find(".num").val(),g+=parseFloat(h));for(var m=$(e[n]).find(".manselect .send-full-span"),u=0;u<c.length;u++){if(c[u].manselect_nums-g>0){if(u>0){m.text("已满足【"+c[u-1].manselect_money+"元任选"+c[u-1].manselect_nums+"件】");break}m.text("再购"+(c[u].manselect_nums-g)+"件立享【"+c[u].manselect_money+"元任选"+c[u].manselect_nums+"件】");break}if(c[u].manselect_nums-g==0){m.text("已满足【"+c[u].manselect_money+"元任选"+c[u].manselect_nums+"件】");break}c[u].manselect_nums-g<0&&m.text("已满足【"+c[u].manselect_money+"元任选"+c[u].manselect_nums+"件】")}for(var h,f=0;f<s.length;f++){var _=$(s[f]).find(".goods-price").text().slice(1);if(h=$(s[f]).find(".num").val(),a+=parseFloat(_*h),c.length>0&&1==$(s[f]).attr("goods_activity_state")){var v=$(s[f]).find(".goods-price").text().slice(1);manselectnum=$(s[f]).find(".num").val();var k=$(s[f]).parents(".store_goods").find(".manselect");k.attr("manselect_nums1")&&p+manselectnum-k.attr("manselect_nums1")>=0?(i+=parseFloat(v*(k.attr("manselect_nums1")-p)),r=i-k.attr("manselect_money1")):k.attr("manselect_nums0")&&p+manselectnum-k.attr("manselect_nums0")>=0?(i+=parseFloat(v*(k.attr("manselect_nums0")-p)),r=i-k.attr("manselect_money0")):r=0,p+=parseFloat(manselectnum),i+=parseFloat(v*manselectnum)}}a=r&&r>0?t-r:t,$("#total_price").html("￥"+a.toFixed(2)),$(e[n]).find(".div-active").parent().attr("total",a.toFixed(2));var b=$(e[n]).find(".post").attr("free_limit");if(b&&a>=b)$(e[n]).find(".post .send-full-span").text("已包邮");else if(b&&a<b){var y=b-a;$(e[n]).find(".post .send-full-span").text("还差"+y.toFixed(2)+"元包邮")}}}function b(){$("#shopping").on("click",".btn-shopping",function(){var t=$(".stockout").parents(".container").find(".icon-ok-sign.single");$(".stockout").length>0&&t.length>0?layer.msg("所购商品库存不足"):(x(),location.href="../order/order_confirmation.html?cart_info="+N+"&if_cart=1&area=0&miaosha="+U)})}function y(){var t=$(".icon-ok-sign.single").length;0!=t?($("#settle").attr("class","btn-shopping"),$("#delete").addClass("okdelete")):($("#settle").attr("class","btn-unshopping"),$("#delete").removeClass("okdelete"))}function x(){var t,e,n=$(".container .icon-ok-sign").parent();N="",U="";for(var a=0;a<n.length;a++){var i=$(n[a]).find(".app-seckill");if(0!=i.length){var r=$(n[a]).attr("goods_id");U+=r+","}t=$(n[a]).attr("cart_id"),e=$(n[a]).find(".num").val(),N+=t+"|"+e+","}N=N.substring(0,N.length-1),U=U.substring(0,U.length-1)}function F(){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_shopping&op=get_goods_scheme",data:{flag:"wap",type:"cainixihuan",num:4,curpage:1},dataType:"json",success:function(t){if(t&&"0"===t.error){var e=template.render("like_goods",t);$("#likeGoods").html(e);var n=parseInt(.49*($(".container").width()+30));$(".brand-ul img").css({height:n+"px"})}}})}function w(t){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_cart&op=del",data:{mid:FL.mid,token:FL.token,cart_id:t,gc_area:0,flag:"wap"},dataType:"json",success:function(t){if(t&&"0"==t.error){for(var e=$(".icon-ok-sign.single"),n=0;n<e.length;n++){var a=$(e[n]).parents(".store_goods"),i=$(e[n]).parents(".container");i.next(".empty").remove(),i.remove();var r=a.find(".container");0==r.length&&a.remove()}L()}}})}function L(){$(".unvalid .single").attr("class","icon-circle-blank unuseful"),0==$(".store_goods").length&&($("#cart_cn").before(W),s()),0==$(".container").length?$("#edit").hide():$("#edit").show(),$("#start,#delete").hide(),$(".goback").show(),$("#nav-show").show(),$("#likeGoods").show(),$("#bottom").show(),$(".num_opt").show(),$("#editBottom").hide(),y(),$("#delete").removeClass("okdelete"),v()}function S(){$(".fh-btn").click(function(){var t=this,e=$(t).parents(".container").attr("cart_id");$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_cart&op=del",data:{mid:FL.mid,token:FL.token,cart_id:e,gc_area:0,flag:"wap"},dataType:"json",success:function(e){if(e&&"0"==e.error){var n=$(t).parents(".store_goods");$(t).parents(".container").next(".empty").remove(),$(t).parents(".container").remove();var a=n.find(".container");0==a.length&&n.remove(),layer.msg("已移除"),0==$(".store_goods").length&&($("#cart_cn").before(W),$("#likeGoods").hide(),$("#bottom").hide())}}})})}function j(){var t=this,e=$(t).attr("store_id"),n=$(t).attr("free_limit"),a=$(t).attr("total");addcookie("storeTotal",a),location.href="shopping_cart_pinkage.html?store_id="+e+"&free_limit="+n+"&type=post"}function G(){var t=this,e=$(t).attr("store_id"),n=$(t).attr("total");addcookie("storeTotal",n),location.href="shopping_cart_pinkage.html?store_id="+e+"&type=send"}function T(){for(var t=$(".container.valid").find(".goods-price"),e=0;e<t.length;e++){var n=$(t[e]).attr("top_limit"),a=($(t[e]).attr("killing_price"),$(t[e]).attr("goods_price")),i=$($(".container.valid")[e]).find(".num").val();n&&i>n&&0!=n&&($(t[e]).text("￥"+a),$($(".container.valid")[e]).find(".app-seckill").remove(),$($(".container.valid")[e]).find(".sk-limit").remove())}}function C(t){$(".fh-dialog").show(),FL.addShade(),$("#leftbtn").click(function(){$(".fh-dialog").hide(),FL.removeShade()}),$("#rightbtn").click(function(){$(".fh-dialog").hide(),t(),FL.removeShade()})}function I(t){t&&0==t.error&&("1"==t.result.is_global?$(".shoppingurl").attr("data-href","../shopping/shopping_cart_global.html"):$(".shoppingurl").attr("data-href","../shopping/shopping_cart_cn.html"))}ImgFormat();var N="",U="",W=(GetQueryString("store_id"),'<section class="adr-header" style="top:0px !important"><img class="adr-img mt50" src="../../images/wap/Esearch.png" /><div class="adr-tips color9">购物车空空的!</div><div class="btns"><a href="../index/index.html" class="button button-block  empty-btn pull-left">随便逛逛</a><a href="../member/history_shop.html?index=0" class="button button-block  empty-btn pull-right">查看收藏</a></div></section>');$("#start").click(function(){L()}),$("#edit").click(function(){$("#likeGoods").is(":hidden")||($("#start,#delete").show(),$("#likeGoods").hide(),$("#edit").hide(),$(".goback").hide(),$("#nav-show").hide(),$(".num_opt").hide(),$("#bottom").hide(),$("#editBottom").show(),$(".unuseful").attr("class","icon-circle-blank single font-gray"),s())}),$("#delete").click(function(){var t=$(".icon-ok-sign.single");if(0!=t.length){for(var e="",n=0;n<t.length;n++){var a=$(t[n]).parent().attr("cart_id");e+=a+","}e=e.substring(0,e.length-1),C(function(){w(e)})}else layer.msg("您还没有选择商品哦!")}),FL.getGoodsNum({success:I});var J=function(){this.onLoad=function(){FL.judgeLogin(),e(),b()}};t.Goods=t.Goods||{},Goods.Carts=new J}(this);