!function(e){function t(e){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=common_member&op=get_third_account_info",data:{code:e,type:"wx",flag:"wap"},dataType:"json",success:function(e){if(0==e.error){var t=e.result;_=t.openid,g=t.nickname,h=t.headimgurl,b=t.mobile,addcookie("wx_openid",_),addcookie("wx_nickname",g),addcookie("wx_headimgurl",h),addcookie("wx_phone",b)}else"40029"==e.error&&(_=unescape(getcookie("wx_openid")),g=unescape(getcookie("wx_nickname")),h=unescape(getcookie("wx_headimgurl")),b=unescape(getcookie("wx_phone")));a(m,_,"wx",b)},error:function(e){}})}function a(e,t,a,r){var n;"wx"==a?n={batch_id:e,flag:"wap",wechat_id:t}:"mid"==a&&(n={batch_id:e,flag:"wap",mid:FL.mid}),$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=get_bag_detail",data:n,dataType:"json",success:function(t){if(t&&0==t.error){if(0==t.result.is_gotten)r?o(r):($("#getbag").show(),$("#bag_money").text(t.result.bag_amount),p());else{l=t.result.bag_id,$("#ticket").show(),d=t.result.mobile,template.helper("format",FL.dateFormat);var a=template.render("bag_content",t.result);$("#bag_title").after(a),i(d,!0),c(e)}u=t.result.bag_amount}}})}function o(e){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=get_bag",data:{mobile:e,batch_id:m,wechat_id:_,wechat_name:g,wechat_avatar:h,flag:"wap"},dataType:"json",success:function(t){t&&0==t.error?(l=t.result,$("#getbag").hide(),$("#ticket").show(),i(e)):"2014001"==t.error?location.href="empty_packet.html":layer.msg(t.msg||"领取失败")},complete:function(){$("#grab").removeAttr("disabled")}})}function i(e,t){t?$("#header_title").text("您已领过了哦！"):($("#header_title").text("恭喜您成功领取红包！"),n(l,e)),$("#phone").text(e)}function r(e){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=get_bag_detail",data:{batch_id:m,wechat_id:e,flag:"wap"},dataType:"json",success:function(e){if(e&&0==e.error){template.helper("format",FL.dateFormat);var t=template.render("bag_content",e.result);$("#bag_title").after(t),c(m)}}})}function n(e,t){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=get_coupon",data:{bag_id:e,mobile:t,flag:"wap"},dataType:"json",success:function(e){e&&0==e.error&&("success"!=e.result&&"pending"!=e.result||r(_))}})}function c(e,t){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=get_bag_record",data:{batch_id:e,num:f,curpage:x,flag:"wap"},dataType:"json",success:function(e){if(e&&0==e.error){var a=template.render("bagHistory",e);"append"==t?$("#bag_history").append(a):$("#bag_history").html(a),$(".wx-money").text(u+"元");var o=$(".skip-link").length||0;$("#bag_num").text("共20个优惠礼包，已领取"+o+"个"),$("#bag_history img").lazyload({threshold:200})}}})}function p(){$("#explain").click(function(){$("#mask").show()}),$("#mask,#closebag").click(function(){$("#mask").hide()}),$("#grab").click(function(){var e=this;d=$("#mobile").val(),/^1[3|4|5|7|8|9][0-9]\d{4,8}$/.test(d)&&/^1\d{10}$/.test(d)?($(e).attr("disabled","disabled"),o(d)):layer.msg("请输入正确的手机号")})}function s(){$.ajax({type:"get",url:WapSiteUrl+"/api/index.php?act=buyer_coupon&op=batch_share",data:{batch_id:m,flag:"wap"},dataType:"json",success:function(e){if(e&&0==e.error){var t=e.result.share_title,a=e.result.share_desc,o=bag_details_wx_link+m+"&response_type=code&scope=snsapi_login&state=STATE#wechat_redirect",i=e.result.share_img;FL.wxShare(t,a,o,i)}}})}var l,d,u,_,g,h,b,m=GetQueryString("batch_id"),f=20,x=1,y=function(){this.onLoad=function(){var e=GetQueryString("code");t(e),s()}};e.Packet=e.Packet||{},Packet.BagDetails=new y}(this);