!function(e){function a(){1==l?($($(".tab")[1]).hide(),t(d)):t(d,u)}function t(e,a){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_order&op=get_refund_info",data:{flag:"wap",mid:FL.mid,token:FL.token,order_id:e,rec_id:a},dataType:"json",success:function(e){if(e&&e.result&&(s=e.result.goods_pay_price,$("#max_money").text("最多￥"+e.result.goods_pay_price+"(已扣除优惠券￥"+e.result.coupon_deduct+"元)"),$("#max_num").text("最多"+p+"件"),1==l||1==$(".active").attr("type")||($("#goods_num").show(),$("#max_num").val(p)),e.result.reason)){var a=template.render("refundReason",e.result);$("#refund_reason").before(a)}}})}function n(e){var a=new FormData;a.append("mid",FL.mid),a.append("token",FL.token),a.append("flag","wap"),a.append("type","goods_refund"),a.append("img",$("#avatar")[0].files[0]),$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=common_index&op=image_upload",processData:!1,contentType:!1,data:a,dataType:"json",success:function(a){if(a&&"0"==a.error&&($(e).parent().find("img").attr("src",a.result),$(e).parent().find("img").attr("class","refund-img"),c+=","+a.result,$("#avatar").remove(),$(".refund-li").length<3)){var t=' <li class="refund-li"><input type="file" accept="image/*" capture=camera class="fh-file" id="avatar" name="avatar" /> <img class="width100" /></li>';$("#refund_imgs").append(t),$("#avatar").change(function(){var e=this;n(e)})}},error:function(e){}})}function r(){$(".tab").click(function(){var e=this;$(".tab").removeClass("active"),$(".tab").find("i").remove(),$(e).addClass("active"),$(e).append('<i class="icon-ok"></i>'),1!=$(".active").attr("type")?($("#goods_num").show(),$("#max_num").val(p)):$("#goods_num").hide()}),$("#avatar").change(function(){var e=this;n(e)}),$("#submitForm").click(function(){var e=$(".active").attr("type"),a=$("#buyer_message").val(),t=$("#refund_amount").val(),n=$("#reasons option:selected").val(),r=c.substr(1),f=$("#refund_num").val();t?t>s?layer.msg("输入金额不得大于"+s):1==l?i(d,a,r):1==e?o(d,u,a,t,n,r,0,e):f||0==f?f>p?layer.msg("输入数量不得大于"+p):o(d,u,a,t,n,r,p,e):layer.msg("请输入退货数量"):layer.msg("请输入退款金额")})}function i(e,a,t){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_order&op=add_refund_all",data:{flag:"wap",mid:FL.mid,token:FL.token,order_id:e,buyer_message:a,pic_info:t},dataType:"json",success:function(e){e&&0==e.error&&(layer.msg("提交成功"),setTimeout(function(){location.href="refund_lists.html"},1e3))}})}function o(e,a,t,n,r,i,o,s){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_order&op=add_refund",data:{flag:"wap",mid:FL.mid,token:FL.token,order_id:e,rec_id:a,refund_amount:n,goods_num:o,refund_type:s,reason_id:r,buyer_message:t,pic_info:i},dataType:"json",success:function(e){e&&0==e.error&&(layer.msg("提交成功"),setTimeout(function(){location.href="refund_lists.html"},1e3))}})}var s,d=GetQueryString("order_id"),u=GetQueryString("rec_id"),p=GetQueryString("goods_num"),c="",l=GetQueryString("way")||GetQueryString("refund_type"),f=function(){this.onLoad=function(){a(),r()}};e.Goods=e.Goods||{},Goods.ApplyService=new f}(this);