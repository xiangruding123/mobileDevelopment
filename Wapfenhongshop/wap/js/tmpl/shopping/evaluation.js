$(function(){function e(){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_order&op=get_order_evaluate_goods",data:{mid:FL.mid,order_id:o,token:FL.token,flag:"wap"},dataType:"json",success:function(e){if("0"===e.error){var a=template.render("evaluation-tpl",e);$("#evaluation_detail").html(a);var i=e.result;t(i)}}})}function t(e){function t(e){var t=200;$(e).val().length>t?(content=$(e).val(),$(e).val(content.substring(0,t-1)),layer.msg("评价文字最多200个字")):$(e).parents(".evaluation_detail_list").find(".eva_num").text($(e).val().length)}$(".media-body i").click(function(e,t){var a=this;i(a)}),$("textarea").change(function(){var e=this;t(e)}),$("textarea").keyup(function(){var e=this;t(e)}),$(".anonymity").click(function(){$(this).is(".icon-circle-blank")?($(this).addClass("icon-ok-sign").removeClass("icon-circle-blank"),l=1):($(this).addClass("icon-circle-blank").removeClass("icon-ok-sign"),l=0)}),$(".file").change(function(){var e=this;$(e).parents(".add_pic").find(".pic").length>4?layer.msg("您最多可以添加5张图片"):n(e)}),$("#submit").click(function(){var t=$(".evaluation_detail_list").length-1;if("true"===a(t)){var i=[];$(".evaluation_detail_list").each(function(e){var t=$(".evaluation_detail_list")[e],a=$(t).find(".icon-star").length,n=$(t).find(".evaluation_state").attr("goods_id");txt=$(t).find(".content").val(),images=null;for(var r=$(t).find(".pic").find("img"),s=0;s<r.length;s++)images=images+","+$(r[s]).attr("src");try{images=images.split("null,")[1]}catch(o){images=null}i[e]={goods_id:n,comment:txt,images:images,stars:a}});var n=$("#store_desccredit .icon-star").length||5,s=$("#store_servicecredit .icon-star").length||5,c=$("#store_deliverycredit .icon-star").length||5;i=JSON.stringify(i),is_append=e.evaluation_state,dete={mid:FL.mid,token:FL.token,order_id:o,flag:"wap",is_anonymous:l,is_append:is_append,evaluate_goods:i,store_desccredit:n,store_servicecredit:s,store_deliverycredit:c},r(dete)}})}function a(e){return $(".evaluation_detail_list").eq(e).find(".content").val()?e<1?fl="true":(a(e-1),fl):(layer.msg("请输入评价内容"),$(".evaluation_detail_list").eq(e).find(".content").focus(),"false")}function i(e){$(e).parents(".media-body").find("i").attr("class","icon-star-empty");for(var t=$(e),a=0;a<5&&0!==t.length;a++)t.attr("class","icon-star"),t=t.prev()}function n(e){var t=new FormData;t.append("mid",FL.mid),t.append("token",FL.token),t.append("flag","wap"),t.append("type","goods_evaluation"),t.append("img",$(e)[0].files[0]),swal({title:"",text:"正在努力上传...",showConfirmButton:!1}),$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=common_index&op=image_upload",processData:!1,contentType:!1,dataType:"json",data:t,success:function(t){t&&"0"==t.error?(swal("","上传成功！","success"),$(e).parents(".add_pic").find(".other").before('<li class="pic"><a href="'+t.result+'" data-lightbox="example-set-com"><img src="'+t.result+'"/></a><span class="picClose"></span></li>'),$(".picClose").click(function(){$(this).parent(".pic").remove()})):swal("","上传失败，请重试~","error")},error:function(e){swal("","上传失败，请重试~","error")}})}function r(e){$.ajax({type:"post",url:WapSiteUrl+"/api/index.php?act=buyer_order&op=batch_evaluate",data:e,dataType:"json",success:function(e){e&&"0"===e.error?(0==e.result?layer.msg("评论成功！"):layer.msg("评论成功！获得"+e.result+"积分~"),setTimeout(function(){location.href="../order/order_all.html?index=4"},2e3)):layer.msg("评价失败")}})}var s=GetQueryString("if_append_evaluate"),o=GetQueryString("order_id"),l=1;1==s&&$("#store_credit").hide(),e()});